---
title: "HBA2025_results"
author: "Paloma"
date: "2025-01-27"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

Here you will find the code used to obtain results shown in the annual meeting of the HBA, 2025. 

Abstract:

**Coping with water insecurity: women's strategies and emotional responses in Iztapalapa,
Mexico City**

Water insecurity in urban areas presents distinctive challenges, particularly in marginalized communities. While past studies have documented how households adapt to poor water services, many of these coping strategies come at a significant personal cost. Here we examine the **coping strategies and emotional impacts of unreliable water services** among 400 women in Iztapalapa, Mexico City. Data were collected through surveys over the Fall of 2022 and Spring of 2023. We assessed **household water access, water management practices, and emotional responses to local water services.** 

Results indicate that during acute water shortages, women can spend extended periods (several hours, or sometimes days) waiting for water trucks. Additionally, 57% of respondents reported feeling frustrated or angry about their water situation, while around 20% experienced family conflicts over water use or community-level conflicts around water management, often involving water vendors or government services. 

This study offers one of the first in-depth examinations of how water insecurity specifically affects women in Iztapalapa, a densely populated region of Mexico City with severe water access challenges. The findings highlight the urgent need for policy interventions that address water insecurity with a gender-sensitive approach, recognizing the disproportionate burden placed on women as primary water managers in their households.

```{r libraries, echo = FALSE, warning = FALSE, message= FALSE}

# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(reshape2) 
library(knitr)
# Load the dataset

data <- read.csv("/Users/palomacz/Documents/GitHub/QUAIL-Mex/data/Cleaned_Dataset_Screening_HWISE_PSS_V3.csv")

```

```{r HWISE categ}

# Ensure HW_TOTAL is numeric
data$HW_TOTAL <- as.numeric(data$HW_TOTAL)

# Categorize HW_TOTAL into four groups
data <- data %>%
  mutate(HW_TOTAL_category = case_when(
    HW_TOTAL >= 0 & HW_TOTAL <= 2  ~ "No-to-Marginal",
    HW_TOTAL >= 3 & HW_TOTAL <= 11 ~ "Low",
    HW_TOTAL >= 12 & HW_TOTAL <= 23 ~ "Moderate",
    HW_TOTAL >= 24 & HW_TOTAL <= 36 ~ "High",
    TRUE ~ NA_character_  # Assign NA if value is missing or out of range
  ))

# Convert to factor to maintain categorical order
data$HW_TOTAL_category <- factor(data$HW_TOTAL_category, 
                                 levels = c("No-to-Marginal", "Low", "Moderate", "High"))

# HWISE scores 
summary(data$HW_TOTAL)
# Check the new variable distribution
table(data$HW_TOTAL_category)

```

```{r echo=FALSE}

# Create a data frame with category counts
hw_total_counts <- data.frame(
  HW_TOTAL_category = factor(c("No-to-Marginal", "Low", "Moderate", "High"), 
                             levels = c("No-to-Marginal", "Low", "Moderate", "High")),
  Count = c(76, 205, 104, 6)  # Given category frequencies
)

# Calculate the total count and percentage for each category
hw_total_counts <- hw_total_counts %>%
  mutate(Percentage = (Count / sum(Count)) * 100)

# Create the bar plot with percentages
ggplot(hw_total_counts, aes(x = HW_TOTAL_category, y = Percentage, fill = HW_TOTAL_category)) +
  geom_bar(stat = "identity") +  # Use stat="identity" for predefined percentages
  theme_minimal() +
  labs(title = "Distribution of HWISE Categories (Percentages)",
       x = "HW_TOTAL Category", 
       y = "Percentage") +
  scale_fill_manual(values = c("#1f78b4", "#a6cee3", "#fdbf6f", "#ff7f00")) +  # Custom colors
  theme(legend.position = "none") +  # Remove legend
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) # Add percentage labels

```


```{r echo=FALSE}

# Convert SEASON to a factor with labels
data$SEASON <- factor(data$SEASON, levels = c(0, 1), labels = c("Dry", "Rainy"))

# Create HW_TOTAL categories
data <- data %>%
  mutate(HW_TOTAL_category = case_when(
    HW_TOTAL >= 0 & HW_TOTAL <= 2  ~ "No-to-Marginal",
    HW_TOTAL >= 3 & HW_TOTAL <= 11 ~ "Low",
    HW_TOTAL >= 12 & HW_TOTAL <= 23 ~ "Moderate",
    HW_TOTAL >= 24 & HW_TOTAL <= 36 ~ "High",
    TRUE ~ NA_character_  # Assign NA for missing or out-of-range values
  ))

# Convert to factor with proper ordering
data$HW_TOTAL_category <- factor(data$HW_TOTAL_category, 
                                 levels = c("No-to-Marginal", "Low", "Moderate", "High"))

# Calculate percentages within each season
hw_total_counts <- data %>%
  filter(!is.na(HW_TOTAL_category)) %>% 
  group_by(SEASON, HW_TOTAL_category) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  group_by(SEASON) %>%
  mutate(Percentage = (Count / sum(Count)) * 100)

# Create the bar plot with percentages, faceted by SEASON
ggplot(hw_total_counts, aes(x = HW_TOTAL_category, y = Percentage, fill = HW_TOTAL_category)) +
  geom_bar(stat = "identity") +  # Use predefined percentages
  theme_minimal() +
  labs(title = "Distribution of HWISE Categories by Season",
       x = "HWISE Category", 
       y = "Percentage") +
  scale_fill_manual(values = c("#1f78b4", "#a6cee3", "#fdbf6f", "#ff7f00")) +
  theme(legend.position = "none") +  # Remove legend
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = -0.5) +  # Add percentage labels
  facet_wrap(~SEASON)  # Separate plots by season

# HWISE scores 
dry <- data[c(data$SEASON == "Dry"), ]
rainy <- data[c(data$SEASON == "Rainy"), ]
summary(dry$HW_TOTAL)
summary(rainy$HW_TOTAL)
# Check the new variable distribution
table(dry$HW_TOTAL_category)
table(rainy$HW_TOTAL_category)
```

# Rainy season to dry season

```{r}

data <- read.csv("/Users/palomacz/Documents/GitHub/QUAIL-Mex/data/Cleaned_Dataset_Screening_HWISE_PSS_V3.csv")

# Define Rainy (Fall = 1) and Dry (Spring = 0) seasons
data <- data %>%
  mutate(Season_Type = case_when(
    SEASON == 1 ~ "Rainy",
    SEASON == 0 ~ "Dry"
  ))

# Convert Season_Type to a factor
data$Season_Type <- factor(data$Season_Type, levels = c("Rainy", "Dry"))

# Categorize HW_TOTAL into four groups
data <- data %>%
  filter(!is.na(HW_TOTAL)) %>%  # Remove missing values
  mutate(HW_TOTAL_category = case_when(
    HW_TOTAL >= 0 & HW_TOTAL <= 2  ~ "No-to-Marginal",
    HW_TOTAL >= 3 & HW_TOTAL <= 11 ~ "Low",
    HW_TOTAL >= 12 & HW_TOTAL <= 23 ~ "Moderate",
    HW_TOTAL >= 24 & HW_TOTAL <= 36 ~ "High"
  ))

# Convert to factor with correct ordering
data$HW_TOTAL_category <- factor(data$HW_TOTAL_category, 
                                 levels = c("No-to-Marginal", "Low", "Moderate", "High"))

# Calculate the percentage for each category within each season
hw_season_counts <- data %>%
  filter(!is.na(HW_TOTAL_category)) %>%  # Ensure no NA categories
  group_by(Season_Type, HW_TOTAL_category) %>%
  summarise(Count = n(), .groups = 'drop') %>%
  group_by(Season_Type) %>%
  mutate(Percentage = (Count / sum(Count)) * 100)

# Reshape data to calculate the percentage difference (Dry - Rainy)
hw_diff <- hw_season_counts %>%
  select(Season_Type, HW_TOTAL_category, Percentage) %>%
  spread(Season_Type, Percentage) %>%  # Convert to wide format
  mutate(Difference = Dry - Rainy)  # Compute difference from Rainy to Dry

# Create the bar plot showing the percentage difference
ggplot(hw_diff, aes(x = HW_TOTAL_category, y = Difference, fill = Difference > 0)) +
  geom_bar(stat = "identity") +  # Use precomputed differences
  theme_minimal() +
  labs(title = "Change in HW_TOTAL Category Percentages (Rainy to Dry Season)",
       x = "HW_TOTAL Category", 
       y = "Percentage Difference (Rainy to Dry season)") +
  scale_fill_manual(values = c("#1f78b4", "#ff7f00"), labels = c("Decrease", "Increase")) +  # Assign colors
  theme(legend.position = "right") +  # Keep legend
  geom_text(aes(label = paste0(round(Difference, 1), "%")), vjust = -0.5)  # Add percentage labels

```

# BOXPLOTS

```{r}

data <- read.csv("./data/Cleaned_Dataset_Screening_HWISE_PSS_V3.csv")

# Categorize HW_TOTAL into four groups
data <- data %>%
  filter(!is.na(HW_TOTAL)) %>%  # Remove missing values
  mutate(HW_TOTAL_category = case_when(
    HW_TOTAL >= 0 & HW_TOTAL <= 2  ~ "No-to-Marginal",
    HW_TOTAL >= 3 & HW_TOTAL <= 11 ~ "Low",
    HW_TOTAL >= 12 & HW_TOTAL <= 23 ~ "Moderate",
    HW_TOTAL >= 24 & HW_TOTAL <= 36 ~ "High"
  ))

# Convert to factor with proper order
data$HW_TOTAL_category <- factor(data$HW_TOTAL_category, 
                                 levels = c("No-to-Marginal", "Low", "Moderate", "High"))

# Count the number of data points per HW_TOTAL category
category_counts <- data %>%
  group_by(HW_TOTAL_category) %>%
  summarise(Count = n(), .groups = 'drop')

# Define color palette
color_palette <- c("#1f78b4", "#a6cee3", "#fdbf6f", "#ff7f00")

# Create box-and-whisker plot with individual data points
ggplot(data, aes(x = HW_TOTAL_category, y = HRS_WEEK, fill = HW_TOTAL_category)) +
    geom_jitter(aes(color = HW_TOTAL_category), size = 1, width = 0.25) +  
  # Jitter adds individual data points
  geom_boxplot(outlier.shape = 1, alpha = 0.6, width = 0.4) +  # Boxplot without displaying outliers separately
 # geom_violin(alpha = 0.6, width = 1.4) +  # Boxplot without displaying outliers separately +
  theme_minimal() +
  labs(title = "Box-and-Whisker Plot: HRS_WEEK by HWISE Category",
       x = "HWISE", 
       y = "Hours of Water Supply per Week") +
  scale_fill_manual(values = color_palette) +  # Custom colors for boxes
  scale_color_manual(values = color_palette) +  # Custom colors for points
  theme(legend.position = "none") + # Remove legend for clarity 
scale_x_discrete(labels = paste0(category_counts$HW_TOTAL_category, " (n=", category_counts$Count, ")"))  # Add count to x-axis labels

```

