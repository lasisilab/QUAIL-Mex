---
title: "SOCHIAB_plots"
author: "Paloma"
date: "2024-11-22"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r echo=FALSE}
library(viridis)
library(dplyr)
library(forcats)
library(tidyr)
library(ggplot2)
library(likert)
library(scales)
library(showtext)
showtext_auto()
font_add("RobotoCondensed-Semibold","/Users/lasisilab/Library/Fonts/RobotoCondensed-Semibold.ttf")


```

## Data cleaning

```{r echo = TRUE}
# Set locations and file names
date     <- c("241122")
pss    <- c("data/240201_PSS_clean.csv")
hwise    <- c("data/240201_HWISE_clean.csv")
interm <- c("data/Q3_5_PSS_Hygene_Worry_240416.csv")
q16     <- c("data/240306_SES_HWISE_Q16.csv") 
q9    <- c("data/Q9_10_11_29_31_all.xlsx - Form Responses 1.csv")
ses <- c("data/240306_SES_clean.csv")  #### NOT INCLUDED
```

## LOAD PSS and HWISE 
```{r echo = TRUE}
#Loading file and setting empty cells as "NAs"

pss <- read.csv(pss, stringsAsFactors = TRUE, 
                na.strings = c("", " ","n/a","NA", "N/A"))
hwise <- read.csv(hwise, stringsAsFactors = TRUE, 
                  na.strings = c("", " ","n/a","NA", "N/A"))
interm <- read.csv(interm, stringsAsFactors = TRUE, 
                   na.strings = c("", " ","n/a","NA", "N/A"))
q16 <- read.csv(q16, stringsAsFactors = TRUE, 
                na.strings = c("", " ","n/a","NA", "N/A"))
q9 <- read.csv(q9, stringsAsFactors = TRUE, 
               na.strings = c("", " ","n/a","NA", "N/A"))
#ses <- read.csv(ses, stringsAsFactors = TRUE, 
 #               na.strings = c("", " ","n/a","NA", "N/A"))

head(pss)
dim(pss)
summary(pss)

head(hwise)
dim(hwise)
summary(hwise)

head(interm)
dim(interm)
summary(interm)

head(q16)
dim(q16)

q16 %>% 
 group_by(X5.days.week) %>%
 summarise(n=n())

q16 %>% 
 group_by(X3.days.week) %>%
 summarise(n=n())

head(q9)
dim(q9)
summary(q9)
```


```{r }

# calculate total hwise
f <- hwise
f$wi_levels <- as.factor(ifelse(f$Total_Hwise > 12, "High water insecurity", "Low water insecurity"))
f$wi_levels <- as.factor(ifelse(f$Total_Hwise >= 6, "High water insecurity", "Low water insecurity"))


## Calculate things only using those with high levels of water insecurity
f %>%
    group_by(wi_levels) %>%
    summarise(n=n())


# estimate water worry
f$Worry <- 0
for (i in 1:nrow(f)) { 
    sum(f[i, c(4, 5, 15)]) -> f$Worry[i]
    }
summary(f$Worry)

# estimate reduced scale suggested: clothes, plans, food, hands, body
f$reduced <- 0
for (i in 1:nrow(f)) { 
    sum(f[i, c(6:10)]) -> f$reduced[i]
}

summary(f$reduced)
f$wi_levels_reduced <- as.factor(ifelse(f$reduced >= 3, "High water insecurity", "Low water insecurity"))


```

```{r plot HWISE by question}

# PLot HWISE by question

hwise_long <- 
    hwise %>%
    pivot_longer(!(c(Folio, WS.WI, Season, Total_Hwise)), 
                   names_to = "Question", 
                   values_to = "Score")

hwise_long$Question <- ifelse(hwise_long$Question == "Preocupacion", "Preocupación", 
                    ifelse(hwise_long$Question == "Interrupcion", "Interrupción", 
                    ifelse(hwise_long$Question == "Suenio", "Dormir con sed",  
                    ifelse(hwise_long$Question == "Ninguno", "Sin agua",
                    ifelse(hwise_long$Question == "Verguenza", "Vergüenza", 
                                             "NA")))))


hwise_sum <- hwise_long %>% 
    select(Score, Question) %>%
    drop_na(Score) %>%
    group_by(Question) %>% 
    summarise(mean=mean(Score),
              n=n(), 
              sd = sd(Score), 
              max=max(Score), 
              min=min(Score))
dim(hwise_sum)
head(hwise_sum)

#hwise %>%
#pivot_wider(names_from = )


hwise$Preocupacion<- as.factor(hwise$Preocupacion)

    
hwise <- hwise[,c(1,4:15)]
   
#name.col <- c("Folio", "Preocupacion", "Interrupcion",
                #            "Ropa", "Planes", "Alimentos",
                 #           "Manos", "Cuerpo", "Sin_agua_potable", "Enojo",
                  #          "Dormir_con_sed", "Sin_agua", "Verguenza")    

#colnames(hwise) <- name.col


Folio              <- c("99991", "99992", "99993", "99994")
Interrupcion       <- c(0, 1, 2, 3)
Preocupacion       <- c(0, 1, 2, 3)
Enojo              <- c(0, 1, 2, 3)
Ropa               <- c(0, 1, 2, 3)
Planes             <- c(0, 1, 2, 3)
Bebida             <- c(0, 1, 2, 3)
Suenio             <- c(0, 1, 2, 3)
Cuerpo             <- c(0, 1, 2, 3)
Alimentos          <- c(0, 1, 2, 3)
Ninguno            <- c(0, 1, 2, 3)
Manos              <- c(0, 1, 2, 3)
Verguenza          <- c(0, 1, 2, 3)

fake <- data.frame(Folio, Preocupacion, Interrupcion,
                            Ropa, Planes, Alimentos,
                            Manos, Cuerpo, Bebida,
                            Enojo, Suenio, Ninguno, Verguenza)    

```

```{r plot HWISE likert}
df <- rbind(hwise, fake)
name.col <- c("Folio", "Preocupación", "Interrupción",
                       "Ropa", "Cambió planes", "Cambió alimentos",
                       "Manos", "Cuerpo", "Sin agua potable", "Enojo",
                     "Dormir con sed", "Sin agua", "Vergüenza")    

colnames(df) <- name.col



factor_levels <- c("Nunca","A veces","De vez en\ncuando", "A menudo\no siempre")


for (i in 2:length(df)) {
df[,i]<- as.factor(df[,i]) 
levels(df[,i]) <- factor_levels
}

nrow(df)
sur2 <- subset(df, Folio < 99991) 
sur2 <- sur2[2:length(sur2)]
nrow(sur2)

png(file= "./HWISE_likert_99CCCC_darkgoldenrod.png", width = 1300, height = 750)

plot(likert(sur2), 
     centered = TRUE, 
     center = 1.5, 
     low.color='#99CCCC', 
     high.color='darkgoldenrod', 
     text.size = 9.5, 
     plot.percent.high = TRUE, 
     plot.percent.low = FALSE) + 
     guides(fill = guide_legend(title="Frecuencia")) +
    theme_minimal() + 
    labs(title = paste("Encuesta HWISE, n = ", nrow(sur2), sep=""), 
        y = "Porcentaje", 
    ) +
    theme(
       legend.position = "top",  
       text = element_text(family = "RobotoCondensed-Semibold", size=38), 
       legend.text = element_text(size=26),
       plot.title = element_text(size = 38)) 
  
dev.off()

```

# Q16_Perception of sufficiency

```{r}
## Plotting Q16 
head(q16)

q16s <- q16[,c("Folio", "X1.day.week..6.to.12", "X3.days.week", "X5.days.week")] 

Folio <- c("99991", "99992", "99993", "99994")
X1.day.week..6.to.12 <- c(1, 2, 3, 4) 
X3.days.week <- c(1, 2, 3, 4) 
X5.days.week <- c(1, 2, 3, 4) 

fake <- data.frame(Folio, 
                   X1.day.week..6.to.12, 
                   X3.days.week, 
                   X5.days.week)
sur2 <- rbind(q16s, fake)

factor_levels <- c("Insuficiente","Moderadamente\nsuficiente",
                   "Casi\nsuficiente", "Completamente\nsuficiente")

for (i in 2:length(sur2)) {
sur2[,i]<- as.factor(sur2[,i]) 
levels(sur2[,i]) <- factor_levels
}

name.col <- c("1 día/semana, 6 a 12 hrs", "3 días/semana, 24 hrs", "5 días/semana, 24 hrs")    


nrow(sur2)
sur2 <- subset(sur2, Folio < 99991)
nrow(sur2)
sur3 <- sur2[,2:4] 
colnames(sur3) <- name.col


png(file= "Q16_likert_plot_rm_participants.png", width = 1300, height = 500)
plot(likert(sur3), 
         centered = TRUE,
         center = 3.5,
         wrap = 15,
         include.center = FALSE,
         high.color='#99CCCC', 
         low.color='darkgoldenrod', 
         text.size = 10, 
         plot.percent.high=TRUE, 
         plot.percent.low = FALSE) + 
    labs(y = "Porcentaje", 
         title = paste("Percepción de suficiencia de agua, n = ", 
                        n = nrow(sur2), sep="")) +
    guides(fill = guide_legend(title="Respuesta")) +
    theme_minimal() + 
    theme(
       legend.position = "bottom", 
       text = element_text(family = "RobotoCondensed-Semibold", size=39), 
       legend.text = element_text(size=28),
       plot.title = element_text(size = 39))  
dev.off()
 
```

# Q 29

```{r}
### Q 29 - Priorities
## PLOT PERCENT OF CATEGORY PREFERRED BY PARTICIPANTS
m <- q9 
keep <- c("quality","quality/quantity", 
          "quantity", "pressure", "quality/pressure",
          "nothing", "other", "NA","quality/quantity/pressure", 
          "quantity/pressure")

q29_stats <- m %>%
    select(SampleID, 
           Q29_ImprovementArea_categorical, Q29_ImprovementLikely) %>%
    filter(Q29_ImprovementArea_categorical %in% keep) %>%
    mutate(name = factor(Q29_ImprovementArea_categorical)) %>%
    group_by(Q29_ImprovementArea_categorical) %>%
    summarise(n = n()) 

 q29_stats 
 sum(q29_stats$n) -> n_total
 
q29_stats$Q29_ImprovementArea_categorical <-
   ifelse(q29_stats$Q29_ImprovementArea_categorical == "nothing", "Ninguno",
              ifelse(q29_stats$Q29_ImprovementArea_categorical == "quality", "Calidad",
                      ifelse(q29_stats$Q29_ImprovementArea_categorical == "quantity", "Cantidad",
                              ifelse(q29_stats$Q29_ImprovementArea_categorical == "quality/quantity", "Calidad y Cantidad", 
                                      ifelse(q29_stats$Q29_ImprovementArea_categorical == "quality/pressure", "Calidad y presión",
                                              ifelse(q29_stats$Q29_ImprovementArea_categorical == "pressure", "Presión", 
                                                      ifelse(q29_stats$Q29_ImprovementArea_categorical == "quantity/pressure", "Cantidad y presión", 
                                                              ifelse(q29_stats$Q29_ImprovementArea_categorical == "quality/quantity/pressure", "Cantidad, calidad y presión", "Otro"))))))))
 
# Plot
 library(RColorBrewer)


png(file= "Q29_categorical.png", width = 1200, height = 500) 
q29_stats %>%
   ggplot(aes(x = reorder(Q29_ImprovementArea_categorical, n), 
              y = n/n_total)) +
       geom_bar(stat = "identity", fill = "darkgoldenrod") +  
       labs(title = "Aspectos que necesitan ser mejorados", 
            y = "Porcentaje", x="") +
       coord_flip() + 
       theme_minimal() + 
       scale_y_continuous(labels = scales::percent) + 
       theme(legend.position = "none", 
             text = element_text(family = "RobotoCondensed-Semibold",
                                 size=38), 
          legend.text = element_text(size=26),
          plot.title = element_text(size = 38)) 
dev.off()


```


# SES


```{r}
f <-ses




f$SES <- #ifelse(f$SES_score <= 47,"E", 
                ifelse(f$SES_score <= 89, "D-/E", 
                       ifelse(f$SES_score <= 111, "D", 
                              ifelse(f$SES_score <= 135, "C-",
                                     ifelse(f$SES_score <= 165, "C",
                                            ifelse(f$SES_score <= 204, "C+",
                                                   "A/B")))))#)

 SES       n
  <chr> <int>
1 A/B      28
2 C        84
3 C+       54
4 C-       94
5 D        58
6 D-/E     68
```

